---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Welcome to Astro.">
    <main>
        <div class="page-wrapper">
            <!-- Content wrapper start -->
            <div class="content-wrapper">
                <!--
					Add your page's main content here
					Examples:
					1. https://www.gethalfmoon.com/docs/content-and-cards/#building-a-page
					2. https://www.gethalfmoon.com/docs/grid-system/#building-a-dashboard
				-->

                <div class="container-fluid">
                    <div
                        class="d-flex align-items-center justify-content-center hero"
                    >
                        <div class="content" style="max-width: 500px">
                            <h1 class="content-title text-muted text-center">
                                Today's EA Star Wars Battlefront II Event:
                            </h1>
                            <h2
                                id="todays-event-name"
                                class="content-title text-center"
                            >
                            </h2>
                            <p
                                id="todays-event-description"
                                class="text-center"
                            >
                            </p>
                            <div
                                id="todays-event-game-modes"
                                class="text-center"
                            >
                            </div>
                            <p class="text-center text-muted countdown"></p>
                        </div>
                    </div>
                </div>

                <div class="container">
                    <div class="row">
                        <div class="col-sm-12">
                            <h2>Weekly events</h2>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="card p-0">
                                <img
                                    class="img-fluid rounded-top"
                                    loading="lazy"
                                    src="./images/swbf2/fast-spawn-event.320w.jpg"
                                    srcset="
										./images/swbf2/fast-spawn-event.320w.jpg   320w,
										./images/swbf2/fast-spawn-event.767w.jpg   768w,
										./images/swbf2/fast-spawn-event.1023w.jpg 1024w,
										./images/swbf2/fast-spawn-event.1455w.jpg 1320w,
										./images/swbf2/fast-spawn-event.1920w.jpg 1456w
									"
                                    alt="Star Wars Battlefront II Event: Fast Spawn Event"
                                />
                                <div class="content">
                                    <h2 class="content-title text-muted m-0">
                                        Mondays
                                    </h2>
                                    <h3 class="content-title">
                                        Fast Spawn Event
                                    </h3>
                                    <p>
                                        Spawn timers will be set to 1 sec long
                                        in assault modes for the duration of the
                                        event.
                                    </p>
                                    <div>
                                        <span class="badge"
                                            >Galactic Assault</span
                                        >
                                        <span class="badge"
                                            >Capital Supremacy</span
                                        >
                                        <span class="badge"
                                            >Starfighter Assault</span
                                        >
                                        <span class="badge">Extraction</span>
                                        <span class="badge">Strike</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6">
                            <div class="card p-0">
                                <img
                                    class="img-fluid rounded-top"
                                    loading="lazy"
                                    src="./images/swbf2/midweek-boost.320w.jpg"
                                    srcset="
										./images/swbf2/midweek-boost.320w.jpg   320w,
										./images/swbf2/midweek-boost.767w.jpg   768w,
										./images/swbf2/midweek-boost.1023w.jpg 1024w,
										./images/swbf2/midweek-boost.1455w.jpg 1320w,
										./images/swbf2/midweek-boost.1920w.jpg 1456w
									"
                                    alt="Star Wars Battlefront II Event: Midweek Boost"
                                />
                                <div class="content">
                                    <h2 class="content-title text-muted m-0">
                                        Wednesdays
                                    </h2>
                                    <h3 class="content-title">Midweek Boost</h3>
                                    <p>
                                        Triple XP for faster ranking
                                        progression.
                                    </p>
                                    <div>
                                        <span class="badge">All game modes</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6">
                            <div class="card p-0">
                                <img
                                    class="img-fluid rounded-top"
                                    loading="lazy"
                                    src="./images/swbf2/battle-point-event.320w.jpg"
                                    srcset="
										./images/swbf2/battle-point-event.320w.jpg   320w,
										./images/swbf2/battle-point-event.767w.jpg   768w,
										./images/swbf2/battle-point-event.1023w.jpg 1024w,
										./images/swbf2/battle-point-event.1455w.jpg 1320w,
										./images/swbf2/battle-point-event.1920w.jpg 1456w
									"
                                    alt="Star Wars Battlefront II Event: Battle Point Event"
                                />
                                <div class="content">
                                    <h2 class="content-title text-muted m-0">
                                        Fridays
                                    </h2>
                                    <h3 class="content-title">
                                        Battle Point Event
                                    </h3>
                                    <p>
                                        Lower Battle Point costs for all
                                        reinforcements and increased numbers
                                        allowed at a time.
                                    </p>
                                    <div>
                                        <span class="badge"
                                            >Galactic Assault</span
                                        >
                                        <span class="badge"
                                            >Capital Supremacy</span
                                        >
                                        <span class="badge">Extraction</span>
                                        <span class="badge">Strike</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-12 col-md-6">
                            <div class="card p-0">
                                <img
                                    class="img-fluid rounded-top"
                                    loading="lazy"
                                    src="./images/swbf2/weekend-boost.320w.jpg"
                                    srcset="
										./images/swbf2/weekend-boost.320w.jpg   320w,
										./images/swbf2/weekend-boost.767w.jpg   768w,
										./images/swbf2/weekend-boost.1023w.jpg 1024w,
										./images/swbf2/weekend-boost.1455w.jpg 1320w,
										./images/swbf2/weekend-boost.1920w.jpg 1456w
									"
                                    alt="Star Wars Battlefront II Event: Weekend Boost"
                                />
                                <div class="content">
                                    <h2 class="content-title text-muted m-0">
                                        Saturdays + Sundays
                                    </h2>
                                    <h3 class="content-title">Weekend Boost</h3>
                                    <p>
                                        Double XP for faster ranking
                                        progression.
                                    </p>
                                    <div>
                                        <span class="badge">All game modes</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12">
                            <h2>Special events</h2>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="card p-0">
                                <img
                                    class="img-fluid rounded-top"
                                    loading="lazy"
                                    src="./images/swbf2/battle-point-event-unlimited-power.320w.jpg"
                                    srcset="
										./images/swbf2/battle-point-event-unlimited-power.320w.jpg   320w,
										./images/swbf2/battle-point-event-unlimited-power.767w.jpg   768w,
										./images/swbf2/battle-point-event-unlimited-power.1023w.jpg 1024w,
										./images/swbf2/battle-point-event-unlimited-power.1455w.jpg 1320w,
										./images/swbf2/battle-point-event-unlimited-power.1920w.jpg 1456w
									"
                                    alt="Star Wars Battlefront II Event: Battle Point Event: Unlimited Power"
                                />
                                <div class="content">
                                    <h2 class="content-title text-muted m-0">
                                        Jan 1st + May 4th
                                    </h2>
                                    <h3 class="content-title">
                                        Battle Point Event: Unlimited Power
                                    </h3>
                                    <p>
                                        90% off the Battle Point cost for
                                        everything, increased number of
                                        Reinforcements and Heroes available
                                        simultaneously, with Fast Spawn timers
                                        and Double XP in effect.
                                    </p>
                                    <div>
                                        <span class="badge"
                                            >Galactic Assault</span
                                        >
                                        <span class="badge"
                                            >Capital Supremacy</span
                                        >
                                        <span class="badge">Extraction</span>
                                        <span class="badge">Strike</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <h2>About</h2>
                        </div>
                        <div class="col-sm-12">
                            <div
                                style="margin: auto; max-width: 500px"
                                class="content text-center"
                            >
                                <p>
                                    A calendar of current and upcoming community
                                    events in EA Star Wars Battlefront II
                                    (2017). See today's SWBF2 community event,
                                    and the upcoming SWBF2 community event
                                    schedule.
                                </p>
                                <p>
                                    SWBF2 community events start at 00:01am CET
                                    and conclude the following day at 06:00am
                                    CET, with the exception of Weekend Boost,
                                    which starts at 06:00am Saturday CET and
                                    ends at 11:59pm Sunday CET.
                                </p>
                                <p>
                                    All SWBF2 community events last for a total
                                    of 30 hours.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <nav
                    class="navbar navbar-static-bottom justify-content-between p-10 flex-column"
                >
                    <div class="navbar-text">
                        <div>
                            Made with <i class="fab fa-galactic-republic"></i> by&nbsp;
                            <a
                                href="https://joeduncko.com"
                                target="_blank"
                                rel="noopener">Joe Duncko</a
                            >
                        </div>
                    </div>

                    <div class="navbar-text">
                        <div>
                            Star Wars Battlefront II
                            <i class="far fa-copyright"></i> Electronic Arts Inc.
                        </div>
                    </div>

                    <div class="navbar-text">
                        <a
                            href="https://github.com/JoeDuncko/easwbf2-events"
                            target="_blank"
                            referrerpolicy="origin"
                            rel="noopener"><i class="fas fa-code-branch"></i></a
                        >
                        <a
                            href="https://simpleanalytics.com/swbf2.events?utm_source=swbf2.events"
                            target="_blank"
                            referrerpolicy="origin"
                            rel="noopener"><i class="fas fa-chart-bar"></i></a
                        >
                    </div>
                </nav>
            </div>
            <!-- Content wrapper end -->
        </div>
        <!-- Page wrapper end -->
    </main>
</Layout>

<script>
    import {
        addDays,
        addHours,
        endOfDay,
        isFriday,
        isMonday,
        isSameDay,
        isSaturday,
        isSunday,
        isThursday,
        isTuesday,
        isWednesday,
        parse,
        startOfDay,
    } from "date-fns";

    import { toZonedTime } from "date-fns-tz";

    // TODO: fuse getEndOfEvent and isEventRunning and getBeginningOfEvent
    const events = [
        {
            isEventRunning: (date: Date) => {
                const jan1st = parse(
                    `${new Date().getFullYear()}-1-1`,
                    "y-M-d",
                    new Date()
                );
                const jan2nd = parse(
                    `${new Date().getFullYear()}-1-2`,
                    "y-M-d",
                    new Date()
                );
                const may4th = parse(
                    `${new Date().getFullYear()}-5-4`,
                    "y-M-d",
                    new Date()
                );
                const may5th = parse(
                    `${new Date().getFullYear()}-5-5`,
                    "y-M-d",
                    new Date()
                );

                return (
                    isSameDay(date, jan1st) ||
                    (isSameDay(date, jan2nd) && date.getHours() < 6) ||
                    isSameDay(date, may4th) ||
                    (isSameDay(date, may5th) && date.getHours() < 6)
                );
            },
            getEndOfEvent: (date: Date) => {
                const jan1st = parse(
                    `${new Date().getFullYear()}-1-1`,
                    "y-M-d",
                    new Date()
                );
                const jan2nd = parse(
                    `${new Date().getFullYear()}-1-2`,
                    "y-M-d",
                    new Date()
                );
                const may4th = parse(
                    `${new Date().getFullYear()}-5-4`,
                    "y-M-d",
                    new Date()
                );
                const may5th = parse(
                    `${new Date().getFullYear()}-5-5`,
                    "y-M-d",
                    new Date()
                );

                if (isSameDay(date, jan1st)) {
                    return addHours(endOfDay(date), 6);
                } else if (isSameDay(date, jan2nd) && date.getHours() < 6) {
                    return addHours(startOfDay(date), 6);
                } else if (isSameDay(date, may4th)) {
                    return addHours(endOfDay(date), 6);
                } else if (isSameDay(date, may5th) && date.getHours() < 6) {
                    return addHours(startOfDay(date), 6);
                }

                throw new Error("This should never happen");
            },
            name: "Battle Point Event: Unlimited Power",
            description:
                "90% off the Battle Point cost for everything, increased number of Reinforcements and Heroes available simultaneously, with Fast Spawn timers and Double XP in effect.",
            gameModes: [
                "Galactic Assault",
                "Capital Supremacy",
                "Extraction",
                "Strike",
            ],
        },
        {
            isEventRunning: (date: Date) =>
                isMonday(date) || (isTuesday(date) && date.getHours() < 6),
            getEndOfEvent: (date: Date) => {
                if (isMonday(date)) {
                    return addHours(endOfDay(date), 6);
                } else if (isTuesday(date) && date.getHours() < 6) {
                    return addHours(startOfDay(date), 6);
                }

                throw new Error("This should never happen");
            },
            name: "Fast Spawn Event",
            description:
                "Spawn timers will be set to 1 sec long in assault modes for the duration of the event.",
            gameModes: [
                "Galactic Assault",
                "Capital Supremacy",
                "Starfighter Assault",
                "Extraction",
                "Strike",
            ],
        },
        {
            isEventRunning: (date: Date) =>
                isWednesday(date) || (isThursday(date) && date.getHours() < 6),
            getEndOfEvent: (date: Date) => {
                if (isWednesday(date)) {
                    return addHours(endOfDay(date), 6);
                } else if (isThursday(date) && date.getHours() < 6) {
                    return addHours(startOfDay(date), 6);
                }

                throw new Error("This should never happen");
            },
            name: "Midweek Boost",
            description: "Triple XP for faster ranking progression.",
            gameModes: ["All game modes"],
        },
        {
            isEventRunning: (date: Date) =>
                isFriday(date) || (isSaturday(date) && date.getHours() < 6),
            getEndOfEvent: (date: Date) => {
                if (isFriday(date)) {
                    return addHours(endOfDay(date), 6);
                } else if (isSaturday(date) && date.getHours() < 6) {
                    return addHours(startOfDay(date), 6);
                }

                throw new Error("This should never happen");
            },
            name: "Battle Point Event",
            description:
                "Lower Battle Point costs for all reinforcements and increased numbers allowed at a time.",
            gameModes: [
                "Galactic Assault",
                "Capital Supremacy",
                "Extraction",
                "Strike",
            ],
        },
        {
            isEventRunning: (date: Date) =>
                (isSaturday(date) || isSunday(date),
            getEndOfEvent: (date: Date) => {
                if (isSaturday(date)) {
                    return addHours(endOfDay(date), 24);
                } else if (isSunday(date)) {
                    return endOfDay(date);
                }

                throw new Error("This should never happen");
            },
            name: "Weekend Boost",
            description: "Double XP for faster ranking progression.",
            gameModes: ["All game modes"],
        },
    ];

    const getNow = () => toZonedTime(new Date(), "Europe/Stockholm"); // everything must be in CET since Dice is based in Sweden
    // const getNow = () => new Date("Wed May 5 2022 2:00:00 GMT-0500"); // Test date, for testing

    const findNextEvent = (now: Date) => {
        let nextEvent;
        let nextEventDate = startOfDay(now);
        do {
            nextEventDate = addDays(nextEventDate, 1);
            nextEvent = events.find((event) =>
                event.isEventRunning(nextEventDate)
            );
        } while (!nextEvent);

        return { nextEvent, nextEventDate };
    };

    // See https://stackoverflow.com/a/36592979/3438861
    const setIntervalImmediately = (func: () => void, interval: number) => {
        func();
        return setInterval(func, interval);
    };

    type ArrayElement<A> = A extends readonly (infer T)[] ? T : never;

    const createCountdown = ({
        event,
        countdownDate,
        countdownText,
        doneText,
    }: {
        event: ArrayElement<typeof events>;
        countdownDate: Date;
        countdownText: string;
        doneText: string;
    }) => {
        const countdown = setIntervalImmediately(() => {
            // Need to get new time every interval
            const nowTime = getNow().getTime();

            // Set the date we're counting down to
            const countdownTime = countdownDate.getTime();

            // Find the distance between now and the count down time
            const distance = countdownTime - nowTime;

            // Time calculations for days, hours, minutes and seconds
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
                (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
                (distance % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const countdownDOM = document.querySelector(".countdown");

            if (!countdownDOM) {
                throw new Error("Could not find required elements in DOM");
            }

            countdownDOM.innerHTML = `${countdownText} ${days}d ${hours}h ${minutes}m ${seconds}s`;

            // If the count down is finished
            if (distance < 0) {
                clearInterval(countdown);
                countdownDOM.innerHTML = doneText;
            }
        }, 1000);
    };

    const now = getNow();

    const todaysEvent = events.find((event) => event.isEventRunning(now));

    const todaysEventNameDOM = document.querySelector("#todays-event-name");

    const todaysEventDescriptionDOM = document.querySelector(
        "#todays-event-description"
    );
    const todaysEventGameModesDOM = document.querySelector(
        "#todays-event-game-modes"
    );

    if (
        !todaysEventNameDOM ||
        !todaysEventDescriptionDOM ||
        !todaysEventGameModesDOM
    ) {
        throw new Error("Couldn't find required elements in DOM");
    }

    if (todaysEvent) {
        const gameModesHTML = todaysEvent.gameModes
            .map((gameMode) => `<span class="badge m-5">${gameMode}</span>`)
            .join("");

        createCountdown({
            event: todaysEvent,
            countdownDate: todaysEvent.getEndOfEvent(now),
            countdownText: "Time remaining: ",
            doneText: "Event ending...",
        });

        todaysEventNameDOM.innerHTML = todaysEvent.name;
        todaysEventDescriptionDOM.innerHTML = todaysEvent.description;
        todaysEventGameModesDOM.innerHTML = gameModesHTML;
    } else {
        const { nextEvent, nextEventDate } = findNextEvent(now);

        createCountdown({
            event: nextEvent,
            countdownDate: nextEventDate,
            countdownText: "In",
            doneText: "Starting now...",
        });

        todaysEventNameDOM.innerHTML = `Next event: ${nextEvent.name}`;
    }
</script>
